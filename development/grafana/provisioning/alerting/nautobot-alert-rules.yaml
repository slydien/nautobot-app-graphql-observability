# Grafana Alert Rules for Nautobot Prometheus Metrics
# Drop this file into grafana/provisioning/alerting/ for automatic loading.
# All thresholds are clearly marked with comments for easy customization.
apiVersion: 1

groups:
  # --- GraphQL Alerts ---
  - orgId: 1
    name: GraphQL
    folder: Nautobot
    interval: 1m
    rules:
      - uid: graphql-high-error-rate
        title: GraphQLHighErrorRate
        # Threshold: error rate > 5% over 5 minutes
        condition: D
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: sum(rate(graphql_errors_total[5m]))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: sum(rate(graphql_requests_total[5m]))
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: ($A / $B) * 100
              refId: C
          - refId: D
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: C
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 5
              refId: D
        for: 5m
        annotations:
          summary: "GraphQL error rate is above 5%"
          description: "The GraphQL error rate has exceeded 5% over the last 5 minutes. Current value: {{ $values.C }}%."
        labels:
          severity: warning

      - uid: graphql-slow-queries
        title: GraphQLSlowQueries
        # Threshold: P95 latency > 5 seconds over 5 minutes
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: histogram_quantile(0.95, sum by (le) (rate(graphql_request_duration_seconds_bucket[5m])))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 5
              refId: B
        for: 5m
        annotations:
          summary: "GraphQL P95 latency exceeds 5s"
          description: "The 95th percentile GraphQL query latency has been above 5 seconds for 5 minutes. Current value: {{ $values.A }}s."
        labels:
          severity: warning

      - uid: graphql-deep-queries
        title: GraphQLDeepQueries
        # Threshold: average query depth > 10 over 5 minutes
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: sum(rate(graphql_query_depth_sum[5m])) / sum(rate(graphql_query_depth_count[5m]))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 10
              refId: B
        for: 5m
        annotations:
          summary: "GraphQL average query depth exceeds 10"
          description: "The average GraphQL query depth has been above 10 for 5 minutes. This may indicate abusive or overly nested queries. Current value: {{ $values.A }}."
        labels:
          severity: warning

      - uid: graphql-complex-queries
        title: GraphQLComplexQueries
        # Threshold: average query complexity > 200 over 5 minutes
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: sum(rate(graphql_query_complexity_sum[5m])) / sum(rate(graphql_query_complexity_count[5m]))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 200
              refId: B
        for: 5m
        annotations:
          summary: "GraphQL average query complexity exceeds 200"
          description: "The average GraphQL query complexity (field count) has been above 200 for 5 minutes. Current value: {{ $values.A }}."
        labels:
          severity: warning

  # --- HTTP Alerts ---
  - orgId: 1
    name: HTTP
    folder: Nautobot
    interval: 1m
    rules:
      - uid: nautobot-high-5xx-rate
        title: NautobotHigh5xxRate
        # Threshold: 5xx rate > 1% over 5 minutes
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: sum(rate(django_http_responses_total_by_status_total{status=~"5.."}[5m]))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: sum(rate(django_http_responses_total_by_status_total[5m]))
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: ($A / $B) * 100 > 1
              refId: C
        for: 5m
        annotations:
          summary: "Nautobot 5xx error rate is above 1%"
          description: "The HTTP 5xx error rate has exceeded 1% over the last 5 minutes."
        labels:
          severity: critical

      - uid: nautobot-slow-responses
        title: NautobotSlowResponses
        # Threshold: P95 HTTP latency > 10 seconds over 5 minutes
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: histogram_quantile(0.95, sum by (le) (rate(django_http_requests_latency_seconds_by_view_method_bucket[5m])))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 10
              refId: B
        for: 5m
        annotations:
          summary: "Nautobot P95 HTTP latency exceeds 10s"
          description: "The 95th percentile HTTP response time has been above 10 seconds for 5 minutes. Current value: {{ $values.A }}s."
        labels:
          severity: warning

  # --- Database Alerts ---
  - orgId: 1
    name: Database
    folder: Nautobot
    interval: 1m
    rules:
      - uid: nautobot-db-errors
        title: NautobotDBErrors
        # Threshold: any DB errors in last 5 minutes
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: sum(increase(django_db_errors_total[5m]))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
              refId: B
        for: 5m
        annotations:
          summary: "Nautobot database errors detected"
          description: "Database errors have been observed in the last 5 minutes. Current count: {{ $values.A }}."
        labels:
          severity: critical

      - uid: nautobot-db-slow-queries
        title: NautobotDBSlowQueries
        # Threshold: P95 query duration > 1 second over 5 minutes
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: histogram_quantile(0.95, sum by (le) (rate(django_db_query_duration_seconds_bucket[5m])))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 1
              refId: B
        for: 5m
        annotations:
          summary: "Nautobot P95 DB query duration exceeds 1s"
          description: "The 95th percentile database query duration has been above 1 second for 5 minutes. Current value: {{ $values.A }}s."
        labels:
          severity: warning

  # --- System Alerts ---
  - orgId: 1
    name: System
    folder: Nautobot
    interval: 1m
    rules:
      - uid: nautobot-health-check-failed
        title: NautobotHealthCheckFailed
        # Threshold: any health check returning 0 (DOWN)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: min(health_check_database_info) + min(health_check_redis_backend_info)
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: lt
                    params:
                      - 2
              refId: B
        for: 1m
        annotations:
          summary: "Nautobot health check failed"
          description: "One or more Nautobot health checks (database, redis) are reporting DOWN."
        labels:
          severity: critical

      - uid: nautobot-high-memory
        title: NautobotHighMemory
        # Threshold: resident memory > 1GB (1073741824 bytes)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: process_resident_memory_bytes
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 1073741824
              refId: B
        for: 5m
        annotations:
          summary: "Nautobot memory usage exceeds 1GB"
          description: "Nautobot process resident memory has been above 1GB for 5 minutes. Current value: {{ $values.A }} bytes."
        labels:
          severity: warning

      - uid: nautobot-unapplied-migrations
        title: NautobotUnappliedMigrations
        # Threshold: unapplied migrations > 0
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: DS_PROMETHEUS
            model:
              expr: django_migrations_unapplied_total
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
              refId: B
        for: 5m
        annotations:
          summary: "Nautobot has unapplied database migrations"
          description: "There are unapplied database migrations detected. Run 'nautobot-server migrate' to apply them. Current count: {{ $values.A }}."
        labels:
          severity: info
