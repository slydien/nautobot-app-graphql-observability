---
name: "CI"
concurrency:  # Cancel any existing runs of this workflow for this same PR
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true
on: # yamllint disable-line rule:truthy rule:comments
  push:
    branches:
      - "main"
  pull_request: ~

jobs:
  lint-format:
    name: "Ruff format check"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"
      - name: "Setup Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.12"
      - name: "Install Poetry"
        run: "pipx install poetry==2.1.3"
      - name: "Install dependencies"
        run: "poetry install --only root,dev"
      - name: "Ruff format check"
        run: "poetry run ruff format --check ."

  lint-ruff:
    name: "Ruff lint"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"
      - name: "Setup Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.12"
      - name: "Install Poetry"
        run: "pipx install poetry==2.1.3"
      - name: "Install dependencies"
        run: "poetry install --only root,dev"
      - name: "Ruff lint"
        run: "poetry run ruff check ."

  yamllint:
    name: "YAML lint"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"
      - name: "Setup Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.12"
      - name: "Install Poetry"
        run: "pipx install poetry==2.1.3"
      - name: "Install dependencies"
        run: "poetry install --only root,dev"
      - name: "YAML lint"
        run: "poetry run yamllint ."

  test:
    name: "Tests (Python ${{ matrix.python-version }})"
    needs:
      - "lint-format"
      - "lint-ruff"
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"
      - name: "Setup Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "${{ matrix.python-version }}"
      - name: "Install Poetry"
        run: "pipx install poetry==2.1.3"
      - name: "Install dependencies"
        run: "poetry install"
      - name: "Run tests"
        run: >
          poetry run python -m django test graphene_django_observability
          --settings=test_settings --verbosity=2

  test-coverage:
    name: "Tests with coverage (Python 3.12)"
    needs:
      - "lint-format"
      - "lint-ruff"
    runs-on: "ubuntu-latest"
    permissions:
      pull-requests: "write"
      contents: "write"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"
      - name: "Setup Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.12"
      - name: "Install Poetry"
        run: "pipx install poetry==2.1.3"
      - name: "Install dependencies"
        run: "poetry install"
      - name: "Run tests with coverage"
        run: |
          poetry run coverage run -m django test graphene_django_observability \
            --settings=test_settings --verbosity=2
          poetry run coverage report
          poetry run coverage xml
      - name: "Generate Coverage Comment"
        if: "github.event_name == 'pull_request'"
        id: "coverage_comment"
        uses: "py-cov-action/python-coverage-comment-action@v3"
        with:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MINIMUM_GREEN: 90
          MINIMUM_ORANGE: 80
          ANNOTATE_MISSING_LINES: true
          ANNOTATION_TYPE: "warning"
      - name: "Store Pull Request comment to be posted"
        if: "github.event_name == 'pull_request'"
        uses: "actions/upload-artifact@v4"
        with:
          name: "python-coverage-comment-action"
          path: "python-coverage-comment-action.txt"

  docs:
    name: "Docs build check"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"
      - name: "Setup Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.12"
      - name: "Install Poetry"
        run: "pipx install poetry==2.1.3"
      - name: "Install dependencies"
        run: "poetry install --only dev,docs"
      - name: "Build docs"
        run: "poetry run mkdocs build --strict"

  changelog:
    name: "Changelog entry check"
    if: "github.event_name == 'pull_request'"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Check out repository code"
        uses: "actions/checkout@v4"
        with:
          fetch-depth: "0"
      - name: "Setup Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.12"
      - name: "Install Poetry"
        run: "pipx install poetry==2.1.3"
      - name: "Install dependencies"
        run: "poetry install --only dev"
      - name: "Check for changelog entry"
        run: |
          git fetch --no-tags origin +refs/heads/main:refs/remotes/origin/main
          poetry run towncrier check --compare-with origin/main
